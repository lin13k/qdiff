{% extends "qdiff/base.html" %}
{% load staticfiles %}
{% block sidebar %}
    <li class="nav-item" data-toggle="tooltip" data-placement="right" title="Dashboard">
        <a class="nav-link" href="index.html">
            <i class="fa fa-fw fa-plus-circle"></i>
            <span class="nav-link-text">Create Task</span>
        </a>
    </li>
    <li class="nav-item" data-toggle="tooltip" data-placement="right" title="Dashboard">
        <a class="nav-link" href="index.html">
            <i class="fa fa-fw fa-th-list"></i>
            <span class="nav-link-text">Task List</span>
        </a>
    </li>
{% endblock %}
{% block topbar %}
{% endblock %}
{% block breadcrumbs %}
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="#">Dashboard</a>
        </li>
        <li class="breadcrumb-item">
            <a href="#">Task List</a>
        </li>
        <li class="breadcrumb-item active">Task {{ task.id }}</li>
    </ol>
{% endblock %}
{% block content %}
    <div class="card mb-3">
        <div class="card-header">
        <i class="fa fa-table"></i>Task List
            <div style="float: right;">
                <i class="fa fa-object-group"></i>Group By:
                <input type="text" id="grouping_fields_input" name="grouping_fields">
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            {% for column in columns %}
                                <th>{{ column }}</th>
                            {% endfor %}
                            <th>Source</th>
                        </tr>
                    </thead>
                    <tfoot>
                    <tr>
                        <tr>
                            {% for column in columns %}
                                <th>{{ column }}</th>
                            {% endfor %}
                            <th>Source</th>
                        </tr>
                    </tr>
                    </tfoot>
                    <tbody>
                        {% for record in conflictResults %}
                            <tr>
                                {% for row in record %}
                                    <td>{{ row }}</td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer small text-muted">Updated yesterday at 11:59 PM</div>
    </div>
    <script type="text/javascript">
        $('#grouping_fields_input').on('input', function() {
            var groupingFields = $('#grouping_fields_input').val().split(',');
            var groupingFieldsIndex = [];
            var columns = {{ columns|safe }};
            var columnDefs = [];
            var order = [];
            $('.table > thead > tr > th').each(function(){
                columns.push($.trim($(this).text().toLowerCase()));})
            for (var i = groupingFields.length - 1; i >= 0; i--) {
                groupingFieldsIndex.push(columns.indexOf(groupingFields[i]));
            }
            for (var i = groupingFieldsIndex.length - 1; i >= 0; i--) {
                if (groupingFieldsIndex[i] > -1){
                    columnDefs.push({ "visible": false, "targets": groupingFieldsIndex[i] });
                    order.push([groupingFieldsIndex[i], 'asc']);
                }
            }
            // var groupColumn = 2;
            $('#dataTable').DataTable({
                "columnDefs": columnDefs,
                "order": order,
                "displayLength": 50,
                "drawCallback": function ( settings ) {
                    var api = this.api();
                    var rows = api.rows( {page:'current'} ).nodes();
                    var last=null;
                    
                    for (var i = groupingFieldsIndex.length - 1; i >= 0; i--) {
                        if (groupingFieldsIndex[i] >= 0) {
                            api.column(groupingFieldsIndex[i], {page:'current'} ).data().each( function ( group, i ) {
                                if ( last !== group ) {
                                    $(rows).eq( i ).before(
                                        '<tr class="group"><td colspan="' + columns.length + '">'+group+'</td></tr>'
                                    );
                 
                                    last = group;
                                }
                            });
                        }
                    }         
                },
                "bDestroy": true
            });
         
            // Order by the grouping
            // $('#dataTable tbody').on( 'click', 'tr.group', function () {
            //     var currentOrder = table.order()[0];
            //     if ( currentOrder[0] === groupColumn && currentOrder[1] === 'asc' ) {
            //         table.order( [ groupColumn, 'desc' ] ).draw();
            //     }
            //     else {
            //         table.order( [ groupColumn, 'asc' ] ).draw();
            //     }
            // } );
        } );
    </script>
{% endblock %}
{% block footer %}
{% endblock %}
